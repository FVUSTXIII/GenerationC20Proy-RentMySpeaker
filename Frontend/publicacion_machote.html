<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/publicacion_machote.css">
    <script src="https://kit.fontawesome.com/edb0fd4394.js" crossorigin="anonymous"></script>
    <title>Rent My Speaker</title>
</head>
<body>
    <!--HEADER-->
    <header id ="header-area">
        <h2 id="arrendador"><a href="RentasenProceso.html">Arrendador</a></h2>
        <h2 id="publicar"><a href="publicacionform.html">Publicar</a></h2>
        <!--LOGO AREA-->
        <div id="header-logo-div">
            <i class="fas fa-compact-disc"></i>
            <h1 id="header-title"><a href="index_login.html">Rent My Speaker</a></h1>
        </div>
        <h2 id="arrendatario"><a href="estatus_rentas.html"> Arrendatario</a></h2>
        <a href="index.html"><i class="fas fa-door-open"></i></a>
    </header>      
    
    <main>
        <h1 id="titulo-publicacion"></h1>
        <h2 id="precio-x-dia"></h2>
        <section id="img-container">
           <!-- <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">
            <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">
            <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">
            <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">
            <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">
            <img class="" src="https://ae01.alicdn.com/kf/HTB1FqVsLVXXXXXDXpXXq6xXFXXXK/Alto-C-16-agujeros-cer-mica-Ocarina-leyenda-de-Zelda-Ocarina-flauta-Woodwind.jpg">-->
        </section>
        <section id="descripcion-area">
            <h2>Descripcion</h2>
            <div id="descripcion">
                <!--<p>
                    Esta ocarina de cerámica 12 orificios de alta calidad es hecha a mano y inspirado en la leyenda de Zelda, como si la Trifuerza Triángulo de oro detalle en cromo no lo hacen evidente. Tiene un rango de pitch de A4 a F6 con un sonido nítido y claro, tono y centrado.

                    En consonancia con el tema, esta alta calidad Zelda réplica viene completa con la Zelda Songbook uno de volumen y un folleto de instrucciones en línea.

                    No pierda su dinero en la mala calidad imitaciones que son popping hasta en el mercado. Nuestra Ocarina está afinado con precisión por músicos profesionales y hecho a mano para una apariencia y sonido como ningún otro.<br><br>

                    Características: - -- inspirada en la Legend of Zelda - -- 12 orificios Ocarina - -- Rango de Pitch de A4 a F6 - -- Fabricado en cerámica de alta calidad
                    Banda de cromo - -- con Triforce Triángulo de oro detalle - -- Tuned por músicos profesionales para el mejor sonido - -- Incluye folleto de instrucciones en línea y uno de volumen Zelda Songbook
                    
                </p>-->
            </div>
        </section>

        <form id="precio-total-form">
            <div id="precio-total-calc">
                <div class="precio-total-div">
                    <label class="label-precio-total" for="dias_renta">
                      Dias de renta  
                    </label>
                    <input type="number" id="dias_renta" name="dias_renta" min="1" max="30">
                </div>
                <div class="precio-total-div">
                    <label class="label-precio-total" for="precio_total">
                        Precio total
                    </label>     
                        <input type="text" id="precio_total" name="precio_total" readonly>    
                </div>
            </div>

            <input type="button" value="Enviar Solicitud" id="submit">
        </form>
    </main>
    <script>
        var p_id;
        var post_title = document.getElementById("titulo-publicacion");
        var img_section = document.getElementById("img-container");
        var desc_section = document.getElementById("descripcion");
        var price_per_day = document.getElementById("precio-x-dia");
        var daysElement = document.getElementById("dias_renta");
        var totalPriceText = document.getElementById("precio_total");
        var submitBtn = document.getElementById("submit");
        totalPriceText.value = 0;
        window.onload = () => {
            let p_p_d;
            p_id = localStorage.getItem("idPublicacion");
            let url = "http://localhost:8080/v1/usuario/publicaciones/" + p_id;
            loadPostData(url, (data) => {
                var json = JSON.parse(data);
                p_p_d = parseFloat(json.precio_dia);
                post_title.innerHTML = json.titulo_pub;
                price_per_day.innerHTML =p_p_d;
                dumpImagesIntoDOM(json.imagenes);
                createDesc(json.descripcion);

            }, (data) => {
                console.error("something went wrong", data);
            }); 
        }
        daysElement.onkeyup = (e) => {
            if(e.keyCode == 13){
                submitBtn.click();
            }
            if(daysElement.value > 365){
                alert("Por favor introduce menos días");
                daysElement.value = 365;
            }
            var p_p_d_o = parseFloat(price_per_day.textContent);
            var days = parseInt(daysElement.value);
            var total = p_p_d_o * days;
            totalPriceText.value = total;
        }
        submitBtn.onclick = () => {
            var id_usuario = localStorage.getItem("idUsuario");
            var id_publicacion = p_id;
            let url = "http://localhost:8080/v1/usuario/"+id_usuario+"/publicacion/"+id_publicacion+"/solicitar";
            postRequest(url).then((data) => {
                console.log("Request Submited Successfully");
                window.location.replace("estatus_rentas.html");

            }).catch(() => {
                console.error('Something went wrong');
            });
        }
        function dumpImagesIntoDOM(images) {
            for (i in images) {
                createImgElemnt (images[i].url_img);
            }
        }
        function createDesc(desc) {
            let paragraph = document.createElement("p");
            paragraph.innerHTML = desc;
            desc_section.appendChild(paragraph);
        }
        function createImgElemnt (src) {
            let img_el = document.createElement("img");
            img_el.setAttribute("src", src);
            img_section.appendChild(img_el);
        }
        function loadPostData(url, success, failure) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.onload = () => {
                if (xhr.status === 200) {
                    success(xhr.responseText);
                }
                else {
                    failure(xhr.responseText);
                }
            }
            xhr.send();
        }
        function postRequest(url) {
            var xhttp = new XMLHttpRequest();
                return new Promise ((resolve, reject) => {                      
                    xhttp.onload = () => {
                        if(xhttp.readyState === 4 && xhttp.status === 201) {
                            console.log(xhttp.responseText);
                            resolve(xhttp.responseText);
                        }
                    }
                    xhttp.open('POST' || 'GET', url, true);
                    xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');
                    xhttp.send(getRequestBody());
                });
        }
        function getRequestBody() {
            var requestSub = {};
            requestSub.num_dias = parseInt(daysElement.value);
            var reString = JSON.stringify(requestSub);
            return reString; 
        }
    </script>  
</body>
</html>