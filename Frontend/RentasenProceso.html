<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Rentas</title>
	<link rel="stylesheet" type="text/css" href="css/styleRP.css">
	<script src="https://kit.fontawesome.com/edb0fd4394.js" crossorigin="anonymous"></script>
</head>
<body>
	 <header id ="header-area">
        <h2 id="arrendador"><a href="RentasenProceso.html">Arrendador</a></h2>
        <h2 id="publicar"><a href="publicacionform.html">Publicar</a></h2>
        <!--LOGO AREA-->
        <div id="header-logo-div">
            <i class="fas fa-compact-disc"></i>
            <h1 id="header-title"><a href="index_login.html">Rent My Speaker</a></h1>
        </div>
        <h2 id="arrendatario"><a href="estatus_rentas.html"> Arrendatario</a></h2>
        <a href="index.html"><i class="fas fa-door-open"></i></a>
    </header>  
	<nav id="sidebar">
		<h2 id="nombre_usuario"></h2>
		<ul>
			<li>Publicaciones activas</li>
			<li>Administración de renta</li>
		</ul>
	</nav>

	<main class="administracion_renta">

	</main>	
<script type="text/javascript">
	var id_usuario = localStorage.getItem("idUsuario");
	var nombre_usuario = document.getElementById("nombre_usuario");
	var contenedor_soli_rent = document.getElementsByClassName("administracion_renta")[0];
	window.onload = () => {
		let url1 = "http://localhost:8080/v1/usuario/"+id_usuario;
		let url2 = "http://localhost:8080/v1/usuario/"+id_usuario+"/administracionrentaArrendador/solicitudesRecibidasRentas";
		let url3 = "http://localhost:8080/v1/usuario/"+id_usuario+"/adminstracionDeRentaArrendador/rentasConfirmadas";
		makeRequest(url1).then((data) => {
			var r = JSON.parse(data);
			nombre_usuario.innerHTML = "!Bienvenido, " + r.nombre + "!";
			makeRequest(url2).then((inner_data) => {
				var r1 = JSON.parse(inner_data);
				containerMaker(r1);
				makeRequest(url3).then((deeper_inner_data) => {
					var r2 = JSON.parse(deeper_inner_data);
					containerMaker(r2);
				}).catch((deeper_inner_data) => {
					console.error('Something went wrong', deeper_inner_data);

				});
			}).catch((inner_data) => {
				console.error('Something went wrong', inner_data);
			});
		}).catch((data) => {
			console.error('Something went wrong', data);
		});
	}
	function makeRequest (url) {
            return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.onload = ()  => {
                if (xhr.status  === 200) {
                    resolve(xhr.responseText);  
                }
                else {
                    reject(xhr.responseText);
                }
            };
            xhr.send();
            });            
    }
    function postRequest(url) {
		var xhttp = new XMLHttpRequest();
		return new Promise ((resolve, reject) => {						
			
			xhttp.onload = () => {
				if(xhttp.readyState === 4 && xhttp.status === 201) {
					console.log(xhttp.responseText);
					resolve(xhttp.responseText);
				}
			}
			xhttp.open('POST' || 'GET', url, true);
			//xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');
			xhttp.send();
			console.log("sent");
		});
	}
	function putRequest(url) {
		var xhttp = new XMLHttpRequest();
		return new Promise ((resolve, reject) => {						
			xhttp.onload = () => {
				if(xhttp.status === 200) {
					console.log(xhttp.responseText);
					
				}
				resolve(xhttp.responseText);
			}
			xhttp.open('PUT' || 'GET', url);
			//xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');
			xhttp.send();

		});
	}
    function containerMaker (arr) {
    	for (a in arr) {	
    		if(arr[a].estado_solicitud) {
    			console.log("Esto es una solicitud: ");
    			console.table(arr[a]);
    			crearSolicitudContainer(arr[a]);
    		}
    		else if (arr[a].estado_renta) {
    			console.log("Esto es una renta: ");
    			console.table(arr[a]);
    			crearRentaContiner(arr[a]);
    		}
    		else {
    			console.log("esto es algo no validado aqui");
    		}
    	}
    }
    function crearSolicitudContainer(element) {
    	var cont = document.createElement("div");
    	cont.setAttribute("class", "contenedor_solicitud");
    	estatusSolicitud(cont);
    	lower_body(element, cont);
    	contenedor_soli_rent.appendChild(cont);
    	
    }
    function crearRentaContiner(element) {
    	var cont = document.createElement("div");
    	cont.setAttribute("class", "contenedor_solicitud");
    	if (element.estado_renta == "EN_ESPERA") {
    		estadoRenta_enespera(cont);
    	}
    	else if (element.estado_renta == "EN_PROCESO") {
    		estadoRenta_enproceso(cont);
    	}
    	lower_body(element, cont);
    	contenedor_soli_rent.appendChild(cont);
    }
    function estatusSolicitud(c) {
    	var sol_con = document.createElement("div");
    	sol_con.classList.add("solicitud_renta","sol_status");
    	sol_con.innerHTML = "Solicitud de renta";
    	c.appendChild(sol_con);
    }
    function estadoRenta_enespera(c) {
    	var rent_con = document.createElement("div");
    	rent_con.classList.add("renta_espera", "sol_status");
    	rent_con.innerHTML = "Renta en espera";
    	c.appendChild(rent_con);
    }
    function estadoRenta_enproceso(c) {
    	var rent_con = document.createElement("div");
    	rent_con.classList.add("renta_activa", "sol_status");
    	rent_con.innerHTML = "Renta activa";
    	c.appendChild(rent_con);
    }
    function lower_body(e,c) {
    	var sol_lower_body = document.createElement("div");
    	sol_lower_body.setAttribute("class", "sol_lower_body");
    	var post_data_con = document.createElement("div");
    	post_data_con.setAttribute("class", "post_data_con")
    	lower_body_contents(e, post_data_con);
    	sol_lower_body.appendChild(post_data_con);
    	upper_body(e, sol_lower_body);
    	if (e.estado_solicitud) {
    		button_section(e, sol_lower_body);	
    	}
    	else if (e.estado_renta) {
    		rent_button_section(e, sol_lower_body);
    	}
    	c.appendChild(sol_lower_body);

    }
    function lower_body_contents (e,c) {
    	var post_photo = document.createElement("img");
    	post_photo.setAttribute("class", "post_photo");
    	if(e.estado_solicitud) {
    		post_photo.setAttribute("src", e.url_imagen_publicacion);
    	}
    	else if (e.estado_renta) {
    		post_photo.setAttribute("src", e.url_img_publicacion);		
    	}
    	var post_specifics_con = document.createElement("div");
    	post_specifics_con.setAttribute("class", "post_specifics_con");
    	post_specifications(e,post_specifics_con);
    	c.appendChild(post_photo);
    	c.appendChild(post_specifics_con);
    }
    function post_specifications (e,c) {
    	var p_s_titulo = document.createElement("post_specifics");
    	var p_s_tipo = document.createElement("post_specifics");
    	var p_s_precio = document.createElement("post_specifics");
    	p_s_titulo.setAttribute("class", "post_specifics");
    	p_s_tipo.setAttribute("class", "post_specifics");
    	p_s_precio.setAttribute("class", "post_specifics");
    	if (e.estado_solicitud) {
    		var title = e.titulo_publicacion;
            p_s_titulo.innerHTML ="Título: "+ title.substr(0,15) + "...";
	    	p_s_tipo.innerHTML = "Estado: "+e.estado_solicitud;
	    	p_s_precio.innerHTML = "Precio: $"+e.precio_dia;
	    	c.appendChild(p_s_titulo);
	    	c.appendChild(p_s_tipo);
	    	c.appendChild(p_s_precio);	
    	}
    	else if (e.estado_renta) {
            var title = e.titulo_publicacion;
    		p_s_titulo.innerHTML ="Título: "+ title.substr(0,15) + "...";
    		p_s_tipo.innerHTML = "Estado: "+e.renta;
    		p_s_precio.innerHTML = "Precio: $"+e.precio_dia_publicacion;
    		c.appendChild(p_s_titulo);
    		c.appendChild(p_s_tipo);
    		c.appendChild(p_s_precio);
    	}    	
    }

    function upper_body(e, c) {

    	var abv_fst_inner_sol = document.createElement("div");
    	abv_fst_inner_sol.setAttribute("class", "abv_fst_inner_sol");
    	var user_cred_cont = document.createElement("div");
    	user_cred_cont.setAttribute("class", "user_cred_cont");

    	upper_body_contents(e, user_cred_cont);
    	abv_fst_inner_sol.appendChild(user_cred_cont);
    	c.appendChild(abv_fst_inner_sol);

    }
    function upper_body_contents(e, c) {
    	var user_photo = document.createElement("img");
    	var user_info_con = document.createElement("div");
    	user_info_con.classList.add("post_specifics_con", "user_info_cont");
    	user_photo.setAttribute("class", "user_photo");
    	if (e.estado_solicitud) {
    		user_photo.setAttribute("src", e.url_imagen_usuario);	
    	}
    	else if (e.estado_renta) {
    		user_photo.setAttribute("src", e.url_imagen_solicitante);		
    	}
    	user_specifications(e,user_info_con);
    	c.appendChild(user_photo);
    	c.appendChild(user_info_con);

    }
    function user_specifications(e, c) {
    	var datesplit;
    	var username= document.createElement("div");
    	var phone_number= document.createElement("div");
    	if (e.estado_solicitud) {
    		var datesplit = JSON.stringify(e.fecha_solicitud).split('T');
    		username.innerHTML = e.nombre_usuario;
    		phone_number.innerHTML = e.dias_solicitud + " días";
    	}
    	else if(e.estado_renta) {
    		var datesplit = JSON.stringify(e.fecha_renta).split('T');
    		username.innerHTML = e.nombre_solicitante;
    		phone_number.innerHTML = e.numero_dias_solicitud + " días";
    	 }
    	username.classList.add("user_info", "usern");    	
    	phone_number.classList.add("user_info", "numd");
    	var total_p = document.createElement("div");
    	total_p.classList.add("user_info", "totalp");
    	total_p.innerHTML = e.precio_total;

    	var date = document.createElement("div");
    	date.classList.add("user_info", "req_date");
    	date.innerHTML = datesplit[0].split('"')[1];
    	c.appendChild(username);
    	c.appendChild(phone_number);
    	c.appendChild(total_p);
    	c.appendChild(date);
    }
    function button_section (e, c){
    	var button_con = document.createElement("div");
    	button_con.setAttribute("class", "button_con");
    	button_aceptar(e, button_con);
    	button_rechazar(e, button_con);
    	c.appendChild(button_con);

    }
    function rent_button_section (e, c) {
    	var button_con = document.createElement("div");
    	button_con.setAttribute("class", "button_con");
    	if (e.estado_renta == "EN_ESPERA") {
    		button_entregar(e,button_con);
    	}
    	else if (e.estado_renta == "EN_PROCESO") {
    		button_terminar(e,button_con);
    	}
    	c.appendChild(button_con);
    }
    function button_entregar(e, c) {
    	var but_ent = document.createElement("button");
    	but_ent.setAttribute("class", "e_e");
    	but_ent.innerHTML = "Entregué Mi Equipo";
    	but_ent.addEventListener("click", () => {
    		entregarEquipo(e.id_renta);	
    	}, true);
    	c.appendChild(but_ent);
    }
    function button_terminar(e, c) {
    	var but_ter = document.createElement("button");
    	but_ter.setAttribute("class", "r_e");
    	but_ter.innerHTML = "Recibí Mi Equipo";
    	but_ter.addEventListener("click", () => {
    		recibirEquipo(e.id_renta)	
    	}, true);
    	c.appendChild(but_ter);
    }
    function button_aceptar(e, c) {
    	var but_aceptar = document.createElement("button");
    	but_aceptar.setAttribute("class", "accept");
    	but_aceptar.innerHTML = "Aceptar Solicitud";
    	but_aceptar.addEventListener("click", () => { 
    		aceptarSolicitud(e.id_solicitud);
    	}, false);
    	c.appendChild(but_aceptar);
    }
    function button_rechazar(e, c) {
    	var but_rechazar = document.createElement("button");
    	but_rechazar.setAttribute("class", "rechazar");
    	but_rechazar.innerHTML = "Rechazar Solicitud";
    	but_rechazar.addEventListener("click", () => {
    		rechazarSolicitud(e.id_solicitud);
    	}, false);
    	c.appendChild(but_rechazar);
    }
    function aceptarSolicitud(id_solicitud) {
    	console.log("id: "+id_solicitud);
    	let url = "http://localhost:8080/v1/usuario/"+id_usuario+"/solicitudes/"+id_solicitud+"/acceptreq";
    	console.log("entered");
    	postRequest(url).then((data) => {
    		var re = JSON.parse(data);
    		reload();
    	}).catch((data) => {
    		console.error("this is what happened: " + data);
    	});

    }
    function rechazarSolicitud(id_solicitud) {
    	let url = "http://localhost:8080/v1/usuario/solicitud/"+id_solicitud+"/changestatsol/1";
    	putRequest(url).then((data) => {
    		console.log("aqui deberia de pasar algo", data);
    		reload();
    	}).catch((data) => {
    	});
    }
    function entregarEquipo(id_renta) {
    	console.log("empezamos");
    	let url = "http://localhost:8080/v1/usuario/rentas/"+id_renta+"/changestatren/1";
    	putRequest(url).then((data) => {
    		console.log("aqui deberia de pasar algo", data);
    		reload();
    	}).catch((data) => {
    	});	
    }
    function recibirEquipo(id_renta) {
    	let url = "http://localhost:8080/v1/usuario/rentas/"+id_renta+"/changestatren/2";
    	putRequest(url).then((data) => {
    		console.log("aqui deberia de pasar algo", data);
    		reload();
    	}).catch((data) => {
    	});
    }
 	function reload() {
 		window.location.reload();
 	}

</script>
</body>
</html>
